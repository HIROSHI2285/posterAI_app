# 連続編集時の制約と回避策

## 問題の本質

画像生成後の編集機能において、**1回目の編集は上手く反映するが、2回目以降の編集が意図通りに反映されない**ことがあります。

### なぜこの問題が発生するのか

1. **AIモデルの制約**
   - Gemini APIは各編集リクエストを**独立した処理**として扱います
   - 編集の履歴や累積的な変更を記憶していません
   - 前回の編集内容を完全に維持することは技術的に困難です

2. **画像情報の損失**
   - 編集された画像は前回の編集意図を「含んでいない」
   - AIは画像を見ても「どの部分が以前編集されたか」を判断できません
   - 結果として、新しい編集を行う際に前回の変更が失われる可能性があります

---

## 実施した改善

### プロンプトの強化 (v1.4.1)

`/api/edit/route.ts`のプロンプトを以下のように強化しました：

```typescript
【重要】この画像は既に編集済みの可能性があります。以下の新しい編集指示のみを適用してください。

【編集指示】
${editPrompt}

【厳守事項】
1. 編集指示で明示的に変更を求められた部分のみを修正してください
2. 編集指示に含まれていない要素（テキスト、レイアウト、色、画像、デザイン要素）は絶対に変更しないでください
3. この画像は以前の編集の結果である可能性が高いため、現在の画像の状態を完全に維持したまま、新しい編集指示のみを適用してください
4. 元の画像のスタイル、品質、解像度を完全に維持してください
5. 編集指示が曖昧な場合は、最小限の変更に留めてください
6. 自然な仕上がりになるよう、編集部分を周囲に馴染ませてください
7. 編集前の画像と編集後の画像で、指示された部分以外が変わっていないことを確認してください
```

**改善ポイント**:
- 「既に編集済みの可能性」を明示
- 「現在の画像の状態を完全に維持」を強調
- より具体的な厳守事項を7項目列挙

---

## ユーザー向け推奨ワークフロー

### ✅ 効果的な編集方法

1. **最初の生成で完成度を高める**
   - サンプル画像の解析結果を活用
   - 素材画像を最初から含める
   - 詳細なプロンプトで生成

2. **編集は一度にまとめる**
   ```
   ❌ 悪い例:
   - 1回目: 背景色を青に変更
   - 2回目: タイトルのフォントを変更
   - 3回目: 日付を追加
   
   ✅ 良い例:
   - 1回目: 背景色を青に変更、タイトルのフォントをBoldに、日付「2024/12/25」を右下に追加
   ```

3. **具体的で明確な指示を出す**
   ```
   ❌ 曖昧な指示:
   「もっと明るくして」
   
   ✅ 明確な指示:
   「背景色の明度を20%上げてください。ただし、テキストと画像はそのまま維持してください」
   ```

4. **期待通りの結果にならない場合**
   - 編集を取り消して、最初から作り直す
   - または、最初の生成に戻って再度編集する

---

## 技術的制約

### なぜ完璧な累積編集が難しいのか

1. **画像生成モデルの性質**
   - Geminiは「編集履歴」を持たない
   - 各リクエストは独立して処理される
   - 画像内の「どの部分が変更されたか」を追跡できない

2. **プロンプトの限界**
   - プロンプトで指示できる内容には限度がある
   - AIの解釈に依存する部分が大きい
   - 100%の精度は保証できない

---

## 今後の改善候補

将来的に以下の改善を検討できます：

1. **編集履歴の保存**
   - データベースに各編集の指示を保存
   - 編集時に過去の指示を累積的に送信

2. **レイヤーシステムの導入**
   - 背景、テキスト、画像などをレイヤーとして管理
   - 各レイヤーを個別に編集

3. **プレビュー機能の追加**
   - 編集前後の比較表示
   - 変更が意図通りか確認してからコミット

---

## まとめ

**現状の制約**:
- AIモデルの性質上、2回目以降の編集は前回の変更を完全に保持できない可能性がある
- プロンプト強化で改善できるが、100%の精度は困難

**推奨される使い方**:
- 最初の生成で完成度を高める
- 編集は一度にまとめて行う
- 具体的で明確な指示を出す

**v1.4.1での改善**:
- プロンプトを大幅に強化し、累積編集の精度を向上
- ただし、AIモデルの根本的な制約は残る
