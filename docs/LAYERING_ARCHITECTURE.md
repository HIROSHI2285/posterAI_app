# ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ è©³ç´°å®Ÿè£…è¨ˆç”»

## ğŸ¯ ç›®æ¨™

**ã€ŒAIã«æã‹ã›ã‚‹ã€ã‹ã‚‰ã€ŒAIã¨å…±ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹ã€ã¸ã®ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ ã‚·ãƒ•ãƒˆ**

Gemini APIãŒå‡ºåŠ›ã™ã‚‹1æšã®ãƒ©ã‚¹ã‚¿ãƒ¼ç”»åƒã‚’å‹•çš„ã«åˆ†è§£ã—ã€Fabric.jsã§è‡ªç”±ã«ç·¨é›†å¯èƒ½ãªãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å†æ§‹ç¯‰ã™ã‚‹ã€‚

---

## ğŸ“ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ] â†’ [Gemini 3.0 Pro] â†’ [ãƒ©ã‚¹ã‚¿ãƒ¼ç”»åƒ (PNG)]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åˆ†è§£ãƒ•ã‚§ãƒ¼ã‚º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Gemini Vision â”‚   â”‚    SAM 2      â”‚   â”‚   Inpaint     â”‚      â”‚
â”‚  â”‚ (ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)  â”‚   â”‚ (ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)   â”‚   â”‚ (èƒŒæ™¯è£œå®Œ)    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                   â”‚                   â”‚                â”‚
â”‚         â–¼                   â–¼                   â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚              ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ (JSON)                    â”‚      â”‚
â”‚  â”‚  - texts: [{content, bbox, style}]                    â”‚      â”‚
â”‚  â”‚  - objects: [{type, bbox, imagePNG}]                  â”‚      â”‚
â”‚  â”‚  - background: {imagePNG}                             â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å†æ§‹ç¯‰ãƒ•ã‚§ãƒ¼ã‚º                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Fabric.js Canvas                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ å‰é¢: fabric.IText (ãƒ†ã‚­ã‚¹ãƒˆ)                   â”‚    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚  â”‚  â”‚ ä¸­é–“: fabric.Image (ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)              â”‚    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚  â”‚  â”‚ èƒŒé¢: canvas.backgroundImage (èƒŒæ™¯)            â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‡ºåŠ›ãƒ•ã‚§ãƒ¼ã‚º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [PNG å‡ºåŠ›] / [SVG å‡ºåŠ› (ãƒ™ã‚¯ã‚¿ãƒ¼)] / [PDF å‡ºåŠ› (å°åˆ·ç”¨)]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Step A: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®åŒæ™‚å–å¾—ï¼ˆGemini Visionï¼‰

### ç›®çš„
ç”Ÿæˆã—ãŸç”»åƒã‹ã‚‰ã€Œè¨­è¨ˆå›³ã€ã¨ãªã‚‹JSONå½¢å¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã€‚

### Gemini Vision APIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

```typescript
const extractionPrompt = `
ã“ã®ç”»åƒã‚’è§£æã—ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

{
  "texts": [
    {
      "content": "ãƒ†ã‚­ã‚¹ãƒˆã®å†…å®¹",
      "bbox": {
        "x": 0-1000ã®ç›¸å¯¾åº§æ¨™,
        "y": 0-1000ã®ç›¸å¯¾åº§æ¨™,
        "width": 0-1000ã®ç›¸å¯¾å¹…,
        "height": 0-1000ã®ç›¸å¯¾é«˜ã•
      },
      "style": {
        "fontFamily": "serif" | "sans-serif" | "display",
        "fontWeight": "bold" | "normal",
        "fontSize": "small" | "medium" | "large" | "xlarge",
        "color": "#HEXå€¤",
        "textAlign": "left" | "center" | "right"
      }
    }
  ],
  "objects": [
    {
      "type": "person" | "animal" | "logo" | "product" | "shape",
      "description": "ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜",
      "bbox": {
        "x": 0-1000ã®ç›¸å¯¾åº§æ¨™,
        "y": 0-1000ã®ç›¸å¯¾åº§æ¨™,
        "width": 0-1000ã®ç›¸å¯¾å¹…,
        "height": 0-1000ã®ç›¸å¯¾é«˜ã•
      }
    }
  ],
  "background": {
    "type": "solid" | "gradient" | "image" | "pattern",
    "dominantColor": "#HEXå€¤",
    "description": "èƒŒæ™¯ã®èª¬æ˜"
  }
}

æ³¨æ„:
- åº§æ¨™ã¯0-1000ã®ç›¸å¯¾å€¤ã§è¿”ã—ã¦ãã ã•ã„
- ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºã—ã¦ãã ã•ã„
- ãƒ¡ã‚¤ãƒ³ã®è¢«å†™ä½“ã‚’å¿…ãšæ¤œå‡ºã—ã¦ãã ã•ã„
`;
```

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/analyze-layers/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'

interface LayerMetadata {
  texts: Array<{
    content: string
    bbox: { x: number, y: number, width: number, height: number }
    style: {
      fontFamily: 'serif' | 'sans-serif' | 'display'
      fontWeight: 'bold' | 'normal'
      fontSize: 'small' | 'medium' | 'large' | 'xlarge'
      color: string
      textAlign: 'left' | 'center' | 'right'
    }
  }>
  objects: Array<{
    type: string
    description: string
    bbox: { x: number, y: number, width: number, height: number }
  }>
  background: {
    type: 'solid' | 'gradient' | 'image' | 'pattern'
    dominantColor: string
    description: string
  }
}

export async function POST(request: NextRequest) {
  const { imageData } = await request.json()
  
  const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)
  const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' })
  
  const result = await model.generateContent([
    { text: extractionPrompt },
    { inlineData: { mimeType: 'image/png', data: imageData.split(',')[1] } }
  ])
  
  const metadata: LayerMetadata = JSON.parse(result.response.text())
  
  return NextResponse.json({ metadata })
}
```

---

## ğŸ”§ Step B: èƒŒæ™¯ã®ã€Œç©´åŸ‹ã‚ã€ã¨ç´ ææŠ½å‡º

### B-1: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSAM 2ï¼‰

**é¸æŠè‚¢**:

| æ–¹æ³• | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|---------|-----------|
| **Meta SAM 2 API** | é«˜ç²¾åº¦ã€æœ€æ–° | å¤–éƒ¨ä¾å­˜ã€ã‚³ã‚¹ãƒˆ |
| **Replicate SAM 2** | ç°¡å˜API | å¾“é‡èª²é‡‘ |
| **remove.bg API** | ä½¿ã„ã‚„ã™ã„ | èƒŒæ™¯ã®ã¿ç‰¹åŒ– |
| **ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ** | ç„¡æ–™ã€åˆ¶å¾¡å¯èƒ½ | GPUå¿…è¦ã€è¤‡é›‘ |

**æ¨å¥¨**: æœ€åˆã¯ **Replicate SAM 2** ã¾ãŸã¯ **remove.bg** ã§MVPã€å¾Œã§ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆæ¤œè¨ã€‚

**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `app/api/segment-object/route.ts`

```typescript
export async function POST(request: NextRequest) {
  const { imageData, bbox } = await request.json()
  
  // Replicate SAM 2 APIå‘¼ã³å‡ºã—
  const response = await fetch('https://api.replicate.com/v1/predictions', {
    method: 'POST',
    headers: {
      'Authorization': `Token ${process.env.REPLICATE_API_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      version: 'sam-2-version-id',
      input: {
        image: imageData,
        point_coords: [[bbox.x + bbox.width/2, bbox.y + bbox.height/2]],
        point_labels: [1]
      }
    })
  })
  
  const result = await response.json()
  return NextResponse.json({ segmentedImage: result.output })
}
```

### B-2: èƒŒæ™¯ã®ã‚¤ãƒ³ãƒšã‚¤ãƒ³ãƒ†ã‚£ãƒ³ã‚°

æ¤œå‡ºã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã€Gemini/Imagen Inpaintã§ç©´åŸ‹ã‚ã€‚

```typescript
export async function POST(request: NextRequest) {
  const { imageData, objectMasks } = await request.json()
  
  // ãƒã‚¹ã‚¯ç”»åƒã‚’ä½œæˆï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆéƒ¨åˆ†ã‚’ç™½ã§å¡—ã‚Šã¤ã¶ã—ï¼‰
  const maskImage = createMaskFromBboxes(objectMasks)
  
  // Gemini Inpaintã§èƒŒæ™¯ã‚’è£œå®Œ
  const response = await fetch('/api/edit-region', {
    method: 'POST',
    body: JSON.stringify({
      imageData,
      maskData: maskImage,
      maskEditPrompt: 'å‰Šé™¤ã•ã‚ŒãŸé ˜åŸŸã‚’å‘¨å›²ã®èƒŒæ™¯ã¨è‡ªç„¶ã«é¦´æŸ“ã‚€ã‚ˆã†ã«è£œå®Œã—ã¦ãã ã•ã„'
    })
  })
  
  return NextResponse.json({ backgroundImage: await response.json() })
}
```

---

## ğŸ”§ Step C: Fabric.js ã«ã‚ˆã‚‹å†æ§‹ç¯‰

### åº§æ¨™å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯

```typescript
// AIåº§æ¨™ï¼ˆ0-1000ï¼‰â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã¸ã®å¤‰æ›
function convertCoordinates(
  aiBbox: { x: number, y: number, width: number, height: number },
  canvasWidth: number,
  canvasHeight: number
) {
  return {
    x: (aiBbox.x / 1000) * canvasWidth,
    y: (aiBbox.y / 1000) * canvasHeight,
    width: (aiBbox.width / 1000) * canvasWidth,
    height: (aiBbox.height / 1000) * canvasHeight,
  }
}
```

### Fabric.js ã‚­ãƒ£ãƒ³ãƒã‚¹æ§‹ç¯‰

```typescript
import { fabric } from 'fabric'

interface LayerData {
  metadata: LayerMetadata
  backgroundImage: string
  objectImages: { [id: string]: string }
}

function buildFabricCanvas(
  canvasElement: HTMLCanvasElement,
  layerData: LayerData
) {
  const canvas = new fabric.Canvas(canvasElement)
  const { width, height } = canvas
  
  // 1. èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
  fabric.Image.fromURL(layerData.backgroundImage, (img) => {
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
      scaleX: width / img.width!,
      scaleY: height / img.height!
    })
  })
  
  // 2. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
  layerData.metadata.objects.forEach((obj, index) => {
    const coords = convertCoordinates(obj.bbox, width, height)
    const imageData = layerData.objectImages[`object_${index}`]
    
    fabric.Image.fromURL(imageData, (img) => {
      img.set({
        left: coords.x,
        top: coords.y,
        scaleX: coords.width / img.width!,
        scaleY: coords.height / img.height!,
        selectable: true,
        hasControls: true
      })
      canvas.add(img)
    })
  })
  
  // 3. ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
  layerData.metadata.texts.forEach((text) => {
    const coords = convertCoordinates(text.bbox, width, height)
    
    const fabricText = new fabric.IText(text.content, {
      left: coords.x,
      top: coords.y,
      fontSize: getFontSize(text.style.fontSize, height),
      fontFamily: getFontFamily(text.style.fontFamily),
      fontWeight: text.style.fontWeight,
      fill: text.style.color,
      textAlign: text.style.textAlign,
      selectable: true,
      editable: true
    })
    canvas.add(fabricText)
  })
  
  return canvas
}

// ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¤‰æ›
function getFontSize(size: string, canvasHeight: number): number {
  const ratios = { small: 0.03, medium: 0.05, large: 0.08, xlarge: 0.12 }
  return canvasHeight * (ratios[size] || 0.05)
}

// ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼å¤‰æ›
function getFontFamily(family: string): string {
  const fonts = {
    serif: 'Noto Serif JP',
    'sans-serif': 'Noto Sans JP',
    display: 'M PLUS Rounded 1c'
  }
  return fonts[family] || 'Noto Sans JP'
}
```

---

## ğŸ¨ ç·¨é›†æ©Ÿèƒ½

### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ç·¨é›†å¯èƒ½æ€§

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | Fabric.js ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | ç·¨é›†æ“ä½œ |
|---------|----------------------|---------|
| **ãƒ†ã‚­ã‚¹ãƒˆ** | `fabric.IText` | æ–‡å­—ç·¨é›†ã€ãƒ•ã‚©ãƒ³ãƒˆå¤‰æ›´ã€è‰²å¤‰æ›´ã€ã‚µã‚¤ã‚ºå¤‰æ›´ |
| **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** | `fabric.Image` | ç§»å‹•ã€æ‹¡å¤§ãƒ»ç¸®å°ã€å›è»¢ã€å‰Šé™¤ |
| **èƒŒæ™¯** | `backgroundImage` | ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã€AIå†ç”Ÿæˆã€å·®ã—æ›¿ãˆ |

### ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½

```typescript
// PNGå‡ºåŠ›
function exportPNG(canvas: fabric.Canvas): string {
  return canvas.toDataURL({ format: 'png', quality: 1 })
}

// SVGå‡ºåŠ›ï¼ˆãƒ™ã‚¯ã‚¿ãƒ¼ï¼‰
function exportSVG(canvas: fabric.Canvas): string {
  return canvas.toSVG()
}

// PDFå‡ºåŠ›ï¼ˆjsPDFä½¿ç”¨ï¼‰
async function exportPDF(canvas: fabric.Canvas): Promise<Blob> {
  const { jsPDF } = await import('jspdf')
  const pdf = new jsPDF()
  const imgData = canvas.toDataURL({ format: 'png', quality: 1 })
  pdf.addImage(imgData, 'PNG', 0, 0)
  return pdf.output('blob')
}
```

---

## ğŸ“‹ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 1: OCRæƒ…å ±ã®ãƒãƒƒãƒ”ãƒ³ã‚° âœ… å®Œäº†

- [x] Gemini Vision APIã§ãƒ†ã‚­ã‚¹ãƒˆåº§æ¨™æŠ½å‡º (`/api/extract-text-layers`)
- [x] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆç²¾åº¦å‘ä¸Šï¼‰
- [x] Canvas `IText` ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º (`TextEditCanvas.tsx`)
- [x] ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

### Phase 2: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆ†é›¢ï¼ˆ2é€±é–“ï¼‰

- [ ] SAM 2 / remove.bg APIçµ±åˆ
- [ ] ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] é€éPNGæŠ½å‡ºãƒ»ä¿æŒ
- [ ] Fabric.js `Image` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè¿½åŠ 

### Phase 3: èƒŒæ™¯è£œå®Œï¼ˆ1é€±é–“ï¼‰

- [ ] ãƒã‚¹ã‚¯ç”»åƒç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
- [ ] Inpaint APIå‘¼ã³å‡ºã—
- [ ] ãã‚Œã„ãªèƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ

### Phase 4: çµ±åˆUIï¼ˆ2é€±é–“ï¼‰

- [ ] ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‘ãƒãƒ«UI
- [ ] ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ“ä½œ
- [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆPNG/SVGï¼‰

---

## ğŸš€ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

| å¾“æ¥ | ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒ–å¾Œ |
|------|-------------|
| ã€Œæ–‡å­—ãŒæƒœã—ã„ã€â†’ AIå†ç”Ÿæˆï¼ˆã‚¬ãƒãƒ£ï¼‰ | ãã®å ´ã§ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ç›´ã™ã ã‘ |
| ã€Œé…ç½®ãŒæƒœã—ã„ã€â†’ AIå†ç”Ÿæˆï¼ˆã‚¬ãƒãƒ£ï¼‰ | ãƒã‚¦ã‚¹ã§æ•°ãƒ”ã‚¯ã‚»ãƒ«ãšã‚‰ã™ã ã‘ |
| ã€ŒèƒŒæ™¯ã ã‘å¤‰ãˆãŸã„ã€â†’ å…¨ä½“å†ç”Ÿæˆ | èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘ã‚’æ–°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å·®ã—æ›¿ãˆ |

**å®Œæˆåº¦**: 85-90% â†’ **95-100%å®Œæˆãƒ„ãƒ¼ãƒ«**

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Fabric.js Documentation](http://fabricjs.com/docs/)
- [SAM 2 (Segment Anything Model 2)](https://segment-anything.com/)
- [Replicate API](https://replicate.com/)
- [remove.bg API](https://www.remove.bg/api)
- [Google Fonts - æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆ](https://fonts.google.com/?subset=japanese)

---

## ğŸ“ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**æ¨å¥¨ã•ã‚Œã‚‹æœ€åˆã®ä¸€æ­©**:

> **ã€ŒGemini Vision APIã‚’ä½¿ã£ã¦ã€ç”Ÿæˆã—ãŸç”»åƒã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã®åº§æ¨™ï¼ˆBounding Boxï¼‰ã¨å†…å®¹ã‚’æ­£ç¢ºã«æŠ½å‡ºã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª¿æ•´ã€**ã‹ã‚‰ç€æ‰‹ã€‚

ã“ã‚ŒãŒå®‰å®šã™ã‚Œã°ã€Fabric.jsã¸ã®æµã—è¾¼ã¿ã¯ä¸€æ°—ã«åŠ é€Ÿã—ã¾ã™ã€‚

---

*Created: 2026-01-19*
*Updated: 2026-01-19*
*Status: Phase 1å®Œäº†ã€Phase 2ä»¥é™ã¯å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…*
