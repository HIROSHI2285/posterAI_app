import { GoogleGenerativeAI } from "@google/generative-ai";
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { rateLimiter } from "@/lib/rate-limiter";

// ファイルサイズとMIMEタイプの定数
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];

export async function POST(request: NextRequest) {
    try {
        // 認証チェック
        const session = await getServerSession(authOptions);
        if (!session?.user?.email) {
            return NextResponse.json(
                { error: "認証が必要です" },
                { status: 401 }
            );
        }

        // レート制限チェック（100回/日）
        const { allowed, remaining, resetAt } = rateLimiter.check(session.user.email, 100);
        if (!allowed) {
            return NextResponse.json(
                {
                    error: "本日の画像解析回数上限に達しました",
                    message: `制限は ${new Date(resetAt).toLocaleString('ja-JP')} にリセットされます`
                },
                { status: 429 }
            );
        }

        const body = await request.json();
        const { imageData } = body;

        if (!imageData) {
            return NextResponse.json(
                { error: "画像データが必要です" },
                { status: 400 }
            );
        }

        // ファイルサイズ検証
        if (imageData.length > MAX_FILE_SIZE) {
            return NextResponse.json(
                {
                    error: "ファイルサイズが大きすぎます",
                    message: "最大10MBまでアップロード可能です"
                },
                { status: 413 }
            );
        }

        // MIMEタイプ検証
        const mimeTypeMatch = imageData.match(/data:([^;]+);/);
        const mimeType = mimeTypeMatch?.[1];

        if (!mimeType || !ALLOWED_MIME_TYPES.includes(mimeType)) {
            return NextResponse.json(
                {
                    error: "サポートされていないファイル形式です",
                    message: "JPEG, PNG, WebP, GIF形式のみサポートしています"
                },
                { status: 400 }
            );
        }

        // APIキーの確認
        const apiKey = process.env.GEMINI_API_KEY;

        if (!apiKey) {
            return NextResponse.json(
                {
                    error: "Gemini APIキーが設定されていません",
                    message: ".envファイルにGEMINI_API_KEYを追加してください"
                },
                { status: 500 }
            );
        }

        try {
            // Google AI SDK初期化
            const genAI = new GoogleGenerativeAI(apiKey);

            // 画像解析モデル
            // 現在使用中: "gemini-3-pro-image-preview" ← プレビュー版、高精度 ✅
            // 
            // 理由:
            // - ポスター生成と同じモデルファミリーで統一
            // - 画像理解に特化した高精度
            // - GA版リリース時に一括移行
            // 
            // 将来の移行予定:
            // - "gemini-3-pro-image" (GA版) がリリースされたら移行
            // 
            // 他の選択肢:
            // - "gemini-1.5-pro" - GA版だがコスト高（$0.0028/回）
            // - "gemini-1.5-flash" - 安価で高速（$0.0001/回）
            const model = genAI.getGenerativeModel({
                model: "gemini-3-pro-image-preview"
            });

            // Base64データをパーツに変換
            console.log("=== 画像データ解析開始 ===");
            console.log("画像データ長:", imageData.length);
            console.log("画像データプレフィックス:", imageData.substring(0, 50));

            const base64Data = imageData.split(',')[1];
            const mimeType = imageData.split(',')[0].split(':')[1].split(';')[0];

            console.log("MIME Type:", mimeType);
            console.log("Base64データ長:", base64Data?.length);

            if (!base64Data) {
                throw new Error("Base64データの抽出に失敗しました");
            }

            const imageParts = [
                {
                    inlineData: {
                        data: base64Data,
                        mimeType: mimeType
                    }
                }
            ];


            const prompt = `この画像はポスターまたはデザイン作品です。
AI画像生成ツール（Imagen）で高精度に再現できるように、デザインの構成要素を極めて詳細かつ具体的に言語化して抽出してください。

以下のJSON形式で回答してください（JSONのみ、他のテキストは含めないでください）：

{
  "basicInfo": {
    "mainColor": "メインカラー（必ずHEX形式、例: #87CEEB）",
    "accentColors": ["アクセントカラー1（HEX、例: #FF6B6B）", "アクセントカラー2（HEX）", "アクセントカラー3（HEX、あれば）"],
    "baseColor": "ベース/背景カラー（HEX形式、例: #FFFFFF）",
    "taste": "デザインスタイル（モダン、ミニマル、エレガント、カジュアル、レトロ、和風、ポップなど、できるだけ具体的に。複数の形容詞を組み合わせて）",
    "layout": "レイアウト構成（中央揃え、左右分割、上下分割、三分割、グリッド、非対称など。配置比率を%で明記）",
    "purpose": "想定される用途（イベント告知、商品広告、店内掲示、SNS投稿、チラシなど）",
    "mainTitle": "画像内に見えるメインタイトルやキャッチコピー（正確に転記、改行位置も含めて。なければ空文字）"
  },
  "detailedDescription": "以下の番号付き構造で、AI画像生成（Imagen）で完璧に再現するための超詳細な指示として記述してください。各項目は可能な限り具体的に、合計1500-2500文字程度で記述：

1. 全体的なデザイン・レイアウト構成
構成: レイアウトの分割方法を%単位で具体的に。例: \\"上下二分割レイアウト。上部65%がビジュアル重視エリア（メイン画像+タイトル）、下部35%が情報提示エリア（3カラム構成）。画面中央やや上（画面高の40%位置）に主焦点を配置。\\"

配色システム: 
- メインカラー: 色名、正確なHEX値、使用箇所、面積比率を明記。例: \\"鮮やかなスカイブルー（#87CEEB）。背景の上部グラデーション、全体の65%を占める。トーンは明度85%、彩度70%の爽やかな印象。\\"
- アクセントカラー1: 同様に詳細に。例: \\"ビビッドなコーラルレッド（#FF6B6B）。CTAボタン、見出しアンダーライン、重要テキストに使用。全体の12%。\\"
- アクセントカラー2: 例: \\"ディープゴールド（#FFD700）。装飾要素、星アイコン、価格表示に使用。全体の8%。\\"
- ベースカラー: 例: \\"ピュアホワイト（#FFFFFF）。テキストボックス背景、余白、カード背景。全体の15%。影は薄いグレー（#F5F5F5）で控えめに。\\"

グラデーション・エフェクト:
- グラデーション: 使用している場合は開始色・終了色・方向を明記。例: \\"上から下への線形グラデーション。#87CEEB（上部）から#B0E0E6（下部）。\\"
- 影・光彩: ドロップシャドウやグロー効果の詳細。例: \\"テキストに薄い影（#00000020、2pxオフセット）。ボタンは立体的な影（#00000040、4pxオフセット、8pxぼかし）。\\"

雰囲気・印象: 全体的な印象を5つ以上の形容詞で。例: \\"明るく、親しみやすく、プロフェッショナル、信頼感がある、清潔、開放的、モダン、洗練された印象。若い世代をターゲットにした明るいトーン。\\"

タイポグラフィ詳細: 
- メインタイトル: フォント種類（明朝体/ゴシック体）、ウェイト、サイズ（画面高比%）、行間、字間、配置。例: \\"太字のゴシック体（ウェイト700）。画面高の12%のサイズ。行間1.2倍、字間やや広め（0.05em）。中央揃え。色は濃紺（#003366）。\\"
- サブタイトル: 例: \\"中細のゴシック体（ウェイト400）。メインの60%サイズ。グレー（#666666）。\\"
- 本文: 例: \\"標準ゴシック（ウェイト400）。画面高の3%。行間1.8倍。黒（#333333）。\\"

アートスタイル・画風・タッチ（イラストや装飾がある場合は必須）:
- 画風の種類: 具体的なスタイル名を列挙。例: \\"手描き水彩風\\", \\"フラットデザイン\\", \\"リアルな写実的\\", \\"アニメ風\\", \\"レトロポップ\\", \\"ミニマリスト\\", \\"グランジ\\", \\"パステル調\\", \\"ヴィンテージ\\", \\"モダンアート風\\"
- 線画の特徴: 線の太さ、質感、スタイル。例: \\"細く繊細な線（1-2px）で描かれた手描き風。線には微妙な揺らぎとかすれがあり、温かみのある印象。\\" または \\"太めのくっきりした線（3-4px）、均一でクリーンなベクター風。\\"
- 塗りの技法: 塗り方の詳細。例: \\"水彩のにじみとグラデーション。色が重なる部分に透明感あり。紙の質感が見える。\\" または \\"フラットな単色塗り。影はなく、2-3色で明確に分けられている。\\"
- テクスチャ・質感: 表面の質感。例: \\"紙のざらざらした質感（グレインフィルター30%）\\", \\"滑らかなデジタル質感\\", \\"キャンバス地の織り目\\", \\"古い印刷物のドット感\\"
- ブラシ・筆致: 使用ツールの特徴。例: \\"柔らかい水彩ブラシ、エッジがぼやけている\\", \\"固いマーカー風、エッジが鋭い\\", \\"エアブラシでぼかし\\", \\"ペン画風の細かいハッチング\\"
- 影とハイライトの表現: 陰影の付け方。例: \\"柔らかいグラデーションで影を表現、リアルな立体感\\", \\"アニメ風のセルシェード（明確な2-3段階の影）\\", \\"影なしのフラットスタイル\\"
- 色の扱い: 配色の特徴。例: \\"淡いパステルカラー中心、彩度30-50%\\", \\"ビビッドで鮮やかな原色（彩度80-100%）\\", \\"モノトーン+1色のアクセント\\", \\"アースカラー（茶・緑・ベージュ）中心\\"
- デフォルメ度: リアルさの度合い。例: \\"写実的でリアル（デフォルメなし）\\", \\"やや簡略化された親しみやすいイラスト\\", \\"デフォルメ強め（SDキャラ風）\\", \\"極端に抽象化されたアイコン風\\"
- 参考になるスタイル: 類似スタイル。例: \\"北欧デザイン風\\", \\"昭和レトロ風\\", \\"ピクサー風3D\\", \\"ジブリ背景美術風\\", \\"ポップアート風\\", \\"浮世絵風\\"

2. ビジュアル要素（メイン画像・イラスト・写真）
被写体の詳細描写: 人物がいる場合は年齢、性別、表情、服装、姿勢、アクションを詳細に。物体の場合は形状、素材感、質感を。例: \\"30代前半の日本人女性。ナチュラルで親しみやすい笑顔。明るいベージュのニットカーディガン着用。ヘッドセットを装着し、ノートパソコン（白いMacBook風）に向かって楽しそうに会話している様子。両手は自然にキーボードに置かれ、目線はやや斜め上（カメラ方向ではない）。髪型はミディアムのストレート、ナチュラルメイク。\\"

背景環境の詳細: 環境・家具・装飾を具体的に。例: \\"明るいナチュラルテイストのリビング空間。背後に大きな窓（画面の左30%）があり、柔らかい自然光が入る。窓の外は緑のぼやけた景色。左側に観葉植物（モンステラ、高さ150cm程度）。木製のデスク（オーク材風、明るい茶色#D4A574）とホワイトのモダンな椅子。壁は明るいベージュ（#F5F5DC）。\\"

カメラアングル・構図: 視点、被写体位置、余白を%で。例: \\"やや斜め上から（仰角15度程度）のアングル。被写体は画面左寄り1/3（左から10-40%の範囲）に配置。右側60%は背景とテキストスペース。三分割法の交点に顔を配置。上部に10%、下部に15%の余白。\\"

光と影の詳細: 光源の位置、強さ、影の濃さと方向。例: \\"左斜め前方からの柔らかい自然光（窓光）。顔の左側に明るいハイライト（露出+1.5段程度）。右側に薄い影（透過率30%）。全体的にハイキーで明るい印象（平均輝度75%）。コントラスト比1:3程度の柔らかい照明。バックライトなし。\\"

被写界深度・焦点: 例: \\"被写体にピントが合い、背景は適度にボケている（F2.8程度相当）。前景はなし。\\"

3. テキスト要素（すべてのテキストを網羅）
メインコピー: 
- 位置: 画面内の正確な位置を%で。例: \\"画面右上（右から15%、上から20%の位置から開始）\\"
- 文字内容: 改行位置も含めて正確に転記。例: \\"【大見出し】\\n自宅で はじめる\\nオンライン英会話\\" （改行は\\nで表現）
- スタイル詳細: フォント、サイズ、色、太さ、装飾。例: \\"太字ゴシック（ウェイト700）、黒（#000000）、画面高の10%サイズ、行間1.1倍、中央揃え、テキストに白い縁取り（2px、#FFFFFF）\\"

サブコピー:
- 位置: 例: \\"メインコピーの直下15px\\"
- 文字: 例: \\"初心者でも安心の個別レッスン\\n無料体験実施中\\"
- スタイル: 例: \\"中細ゴシック（ウェイト400）、ダークグレー（#555555）、画面高の4%サイズ\\"

装飾・強調テキスト:
- 位置: 例: \\"右上角、斜め-12度傾け、画面右から5%、上から5%\\"
- 文字: 例: \\"今だけ入会金無料！\\"
- スタイル: 例: \\"太字（ウェイト700）、黄色背景（#FFD700、角丸8px、内側パディング10px）に赤文字（#FF0000）、画面高の3.5%サイズ、軽い影付き\\"

本文・詳細テキスト:
すべてのテキストを列挙し、位置とスタイルを明記。

4. グラフィック要素・装飾（アイコン・図形・ボーダー）
アイコン: 種類、位置、サイズ、色。例: \\"星アイコン（5角星、塗りつぶし）、ゴールド（#FFD700）、画面高の2%サイズ、3つ横並び、評価セクションの上部。\\"

図形・ボーダー: 例: \\"情報カードに角丸長方形（角丸半径10px）、白背景（#FFFFFF）、薄グレーのボーダー（1px、#DDDDDD）、内部パディング20px。\\"

装飾ライン: 例: \\"セクション区切りに水平線（2px、#CCCCCC）、画面幅の80%、中央配置。\\"

5. コンテンツブロック・情報カード
レイアウト構成: ボックス・カードの数、配置、間隔を具体的に。例: \\"下部（画面下から10-35%の範囲）に等間隔で3つのホワイトカード（各カード幅28%、高さ画面高の20%）を横並び配置。カード間の間隔は画面幅の2%。各カードは角丸（12px）、白背景（#FFFFFF）、薄い影（#00000015、4pxオフセット、8pxぼかし）、内側に15pxパディング。\\"

各カードの内容:
- カード1: 上部にアイコン（星、ゴールド#FFD700、高さ15%）、中央に太字見出し（\\"経験豊富な講師陣\\"、黒#000000、カード幅の90%、中央揃え）、下部に説明文（2行、グレー#666666、小サイズ）
- カード2: （同様のフォーマットで詳細記述）
- カード3: （同様のフォーマットで詳細記述）

6. CTA（行動喚起）要素
ボタン詳細: 
- 位置: 例: \\"最下部（画面下から2%）、画面幅95%の帯状\\"
- 色: 例: \\"濃紺グラデーション（#003366から#004488）、黄色文字（#FFD700、強い影#00000060）\\"
- 文字: 例: \\"今すぐ無料体験レッスンに申し込む ▶\\"
- スタイル: 例: \\"太字（ウェイト700）、画面高の6%サイズ、中央揃え、ボタン高さ画面高の8%、角丸6px、立体的な影（#00000040、0px 4px 12px）、ホバー風の明るさ\\"

追加要素: 
- QRコード: あれば位置・サイズ。例: \\"右下角、80x80px、白背景に黒コード\\"
- URL/連絡先: 位置・フォント・サイズ
- SNSアイコン: 種類・配置・サイズ

7. 特記事項（その他の重要な視覚的特徴）
- 特殊効果: グロー、パーティクル、パターンなど
- 質感: マット、グロス、紙質感、メタリックなど
- オーバーレイ: 半透明レイヤー、グラデーションオーバーレイなど
- アニメーション風: 動きを示唆する矢印やラインなど

※すべての色は必ずHEX値（#XXXXXX形式）で記載
※位置・サイズは画面比%または具体的なpx値で記載
※この説明のみでAI画像生成ツールが完璧に再現できるレベルで超詳細に記述
※曖昧な表現は避け、数値と具体例を多用してください"
}`;

            const result = await model.generateContent([prompt, ...imageParts]);
            const response = result.response;
            const text = response.text();

            console.log("画像解析結果（生）:", text);

            // JSONを抽出
            let analysisData;
            try {
                // コードブロックを削除してJSONをパース
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    analysisData = JSON.parse(jsonMatch[0]);
                } else {
                    throw new Error("JSON形式のデータが見つかりません");
                }
            } catch (parseError) {
                console.error("JSON解析エラー:", parseError);
                console.error("元のテキスト:", text);
                return NextResponse.json(
                    {
                        error: "画像解析結果の解析に失敗しました",
                        details: text
                    },
                    { status: 500 }
                );
            }

            console.log("解析データ:", analysisData);

            return NextResponse.json({
                success: true,
                analysis: analysisData,
                message: "画像を解析しました"
            });

        } catch (apiError: any) {
            console.error("=== API エラー詳細 ===");
            console.error("エラーメッセージ:", apiError.message);
            console.error("エラースタック:", apiError.stack);
            console.error("エラーオブジェクト全体:", JSON.stringify(apiError, null, 2));
            return NextResponse.json(
                {
                    error: "画像解析に失敗しました",
                    details: apiError.message || "不明なエラー",
                    errorType: apiError.constructor.name
                },
                { status: 500 }
            );
        }

    } catch (error) {
        console.error("画像解析エラー:", error);
        return NextResponse.json(
            {
                error: "画像解析に失敗しました",
                details: error instanceof Error ? error.message : "不明なエラー"
            },
            { status: 500 }
        );
    }
}
